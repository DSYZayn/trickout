import{D as V}from"./promiseUtils-3ce2a460.js";import{e as S}from"./Queue-4939205d.js";import{G as z}from"./AttributeStoreView-dcb739c3.js";import{i as _}from"./TileContainer-04cf618b.js";import{A as y,e as d,r as p}from"./typedArrayUtil-c81d173a.js";import{u as h}from"./screenUtils-7afeb41c.js";import{$ as R}from"./Extent-52b65909.js";import{m as I}from"./lengthUtils-320ae102.js";import{z as f,$ as b}from"./color-349a3ca2.js";import{e as x,c as g}from"./utils-45a97d77.js";import{l as w}from"./capabilities-55572a33.js";function m(v,e){const t=e.length;if(v<e[0].value||t===1)return e[0].size;for(let s=1;s<t;s++)if(v<e[s].value){const i=(v-e[s-1].value)/(e[s].value-e[s-1].value);return e[s-1].size+i*(e[s].size-e[s-1].size)}return e[t-1].size}class q{constructor(){this.symbolLevels=[],this.vvColorValues=new Float32Array(8),this.vvColors=new Float32Array(32),this.vvOpacityValues=new Float32Array(8),this.vvOpacities=new Float32Array(8),this.vvSizeMinMaxValue=new Float32Array(4),this.outsideLabelsVisible=!1,this._vvMaterialParameters={vvSizeEnabled:!1,vvColorEnabled:!1,vvRotationEnabled:!1,vvRotationType:"geographic",vvOpacityEnabled:!1},this._technique=x}getSizeVVFieldStops(e){const t=this._vvSizeFieldStops;if(t)switch(t.type){case"static":return t;case"level-dependent":return y(t.levels[e],()=>{let s=1/0,i=0;for(const r in t.levels){const l=parseFloat(r),u=Math.abs(e-l);u<s&&(s=u,i=l)}if(s===1/0)return{sizes:new Float32Array([0,0,0,0,0,0]),values:new Float32Array([0,0,0,0,0,0])};const a=2**((e-i)/2),o=d(t.levels[i]),n=new Float32Array(o.values);return n[2]*=a,n[3]*=a,{sizes:d(o.sizes),values:n}});default:return}}get vvMaterialParameters(){return this._vvMaterialParameters}update(e){p(this._vvInfo)&&this._updateVisualVariables(this._vvInfo.vvRanges,e)}setInfo(e,t,s){this._updateEffects(s),this._vvInfo=t,this._technique=g(e),this.rendererSchema=this._technique.createOrUpdateRendererSchema(this.rendererSchema,e)}getVariation(){return{...this._technique.getVariation(this.rendererSchema),outsideLabelsVisible:this.outsideLabelsVisible,supportsTextureFloat:w("2d").supportsTextureFloat}}getVariationHash(){return this._technique.getVariationHash(this.rendererSchema)<<1|(this.outsideLabelsVisible?1:0)}_updateEffects(e){p(e)?this.outsideLabelsVisible=e.excludedLabelsVisible:this.outsideLabelsVisible=!1}_updateVisualVariables(e,t){const s=this._vvMaterialParameters;if(s.vvOpacityEnabled=!1,s.vvSizeEnabled=!1,s.vvColorEnabled=!1,s.vvRotationEnabled=!1,!e)return;const i=e.size;if(i){if(s.vvSizeEnabled=!0,i.minMaxValue){const r=i.minMaxValue;let l,u;if(f(r.minSize)&&f(r.maxSize))if(b(r.minSize)&&b(r.maxSize))l=h(r.minSize),u=h(r.maxSize);else{const c=t.scale;l=h(m(c,r.minSize.stops)),u=h(m(c,r.maxSize.stops))}this.vvSizeMinMaxValue.set([r.minDataValue,r.maxDataValue,l,u])}if(i.scaleStops&&(this.vvSizeScaleStopsValue=h(m(t.scale,i.scaleStops.stops))),i.unitValue){const r=R(t.spatialReference)/I[i.unitValue.unit];this.vvSizeUnitValueToPixelsRatio=r/t.resolution}i.fieldStops&&(this._vvSizeFieldStops=i.fieldStops)}const a=e.color;a&&(s.vvColorEnabled=!0,this.vvColorValues.set(a.values),this.vvColors.set(a.colors));const o=e.opacity;o&&(s.vvOpacityEnabled=!0,this.vvOpacityValues.set(o.values),this.vvOpacities.set(o.opacities));const n=e.rotation;n&&(s.vvRotationEnabled=!0,s.vvRotationType=n.type)}}class D extends _{constructor(e){super(e),this._rendererInfo=new q,this._materialItemsRequestQueue=new S,this.attributeView=new z(()=>this.onAttributeStoreUpdate())}destroy(){this.children.forEach(e=>e.destroy()),this.removeAllChildren(),this.attributeView.destroy(),this._materialItemsRequestQueue.clear()}setRendererInfo(e,t,s){this._rendererInfo.setInfo(e,t,s),this.requestRender()}async getMaterialItems(e,t){if(!e||e.length===0)return[];const s=V();return this._materialItemsRequestQueue.push({items:e,abortOptions:t,resolver:s}),this.requestRender(),s.promise}doRender(e){if(e.context.capabilities.enable("textureFloat"),e.context.capabilities.enable("vao"),this._materialItemsRequestQueue.length>0){let t=this._materialItemsRequestQueue.pop();for(;t;)this._processMaterialItemRequest(e,t),t=this._materialItemsRequestQueue.pop()}super.doRender(e)}renderChildren(e){for(const t of this.children)t.commit(e);this._rendererInfo.update(e.state),super.renderChildren(e)}updateTransforms(e){if(this.children.some(t=>t.hasData))for(const t of this.children)t.setTransform(e)}createRenderParams(e){const t=super.createRenderParams(e);return t.rendererInfo=this._rendererInfo,t.attributeView=this.attributeView,t}onAttributeStoreUpdate(){}_processMaterialItemRequest(e,{items:t,abortOptions:s,resolver:i}){const{painter:a,pixelRatio:o}=e,n=t.map(r=>a.textureManager.rasterizeItem(r.symbol,o,r.glyphIds,s));Promise.all(n).then(r=>{if(!this.stage)return void i.reject();const l=r.map((u,c)=>({id:t[c].id,mosaicItem:u}));i.resolve(l)},i.reject)}}export{D as o};
