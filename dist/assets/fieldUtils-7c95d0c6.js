import{_ as L}from"./preload-helper-101896b7.js";import{s as B,a as O}from"./Error-9392329b.js";import{r as u,t as N}from"./typedArrayUtil-c81d173a.js";import{t as H,o as K}from"./string-bf9c68ed.js";import"./geometry-8c15a791.js";import{f as Q}from"./Extent-52b65909.js";var f;function Z(e,t){switch(e.type){case"range":{const r="range"in e?e.range[0]:e.minValue,n="range"in e?e.range[1]:e.maxValue;if(r!=null&&+t<r||n!=null&&+t>n)return f.VALUE_OUT_OF_RANGE;break}case"coded-value":case"codedValue":if(e.codedValues==null||e.codedValues.every(r=>r==null||r.code!==t))return f.INVALID_CODED_VALUE}return null}(function(e){e.VALUE_OUT_OF_RANGE="domain-validation-error::value-out-of-range",e.INVALID_CODED_VALUE="domain-validation-error::invalid-coded-value"})(f||(f={}));const ee=B.getLogger("esri.support.arcadeOnDemand");let b;function U(){return b||(b=(async()=>{const e=await L(()=>import("./arcadeUtils-f4b9e7bd.js").then(t=>t.ax),["assets/arcadeUtils-f4b9e7bd.js","assets/geometry-8c15a791.js","assets/ensureType-8c80e8c7.js","assets/string-bf9c68ed.js","assets/typedArrayUtil-c81d173a.js","assets/Error-9392329b.js","assets/Extent-52b65909.js","assets/cast-4d1aa82d.js","assets/nextTick-3ee5a785.js","assets/promiseUtils-3ce2a460.js","assets/Polyline-7f90e3cc.js","assets/typeUtils-f38bdb16.js","assets/preload-helper-101896b7.js","assets/arcadeTimeUtils-0a92beb1.js","assets/executionError-fb3f283a.js","assets/datetime-b6333958.js","assets/FieldsIndex-29a8df54.js","assets/TimeReference-d5a14980.js","assets/Clonable-ad03ca71.js","assets/number-0ccbbda1.js","assets/locale-30120714.js","assets/Field-899dc481.js","assets/enumeration-de0a766e.js","assets/fieldType-68c65bf7.js","assets/jsonUtils-e2434b33.js","assets/featureConversionUtils-93a98860.js","assets/aaBoundingBox-55a55434.js","assets/mathUtils-505ef34b.js","assets/aaBoundingRect-062d7c89.js","assets/OptimizedFeature-6361f5d1.js","assets/OptimizedFeatureSet-1d1ac4b9.js","assets/request-429c0e66.js","assets/Portal-4a02a9a8.js","assets/Loadable-e19fba09.js","assets/Promise-24c50191.js","assets/PortalGroup-45834c06.js","assets/PortalUser-bb0f9958.js","assets/sizeVariableUtils-d4870b0d.js"]);return{arcade:e.arcade,arcadeUtils:e,Dictionary:e.Dictionary,Feature:e.arcadeFeature}})()),b}const Le=(e,t,r)=>w.create(e,t,r,null,["$feature"]),Oe=(e,t,r)=>w.create(e,t,r,null,["$feature","$view"]),Ue=(e,t,r,n)=>w.create(e,t,r,n,["$feature","$view"]);let w=class R{constructor(t,r,n,i,a,l,s){this.script=t,this.evaluate=i;const _=Array.isArray(l)?l:l.fields;this.fields=_,this._syntaxTree=n,this._arcade=r,this._arcadeFeature=a,this._spatialReference=s,this._referencesGeometry=r.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}static async create(t,r,n,i,a,l){const{arcade:s,Feature:_,Dictionary:T}=await U(),h=Q.fromJSON(r);let c;try{c=s.parseScript(t,l)}catch(o){return ee.error(new O("arcade-bad-expression","Failed to parse arcade script",{script:t,error:o})),null}const A=a.reduce((o,X)=>({...o,[X]:null}),{});let p=null;u(i)&&(p=new T(i),p.immutable=!0,A.$config=null);const E=s.scriptUsesGeometryEngine(c),M=E&&s.enableGeometrySupport(),W=s.scriptUsesFeatureSet(c)&&s.enableFeatureSetSupport(),S=s.scriptIsAsync(c),V=S&&s.enableAsyncSupport(),j={vars:A,spatialReference:h,useAsync:!!V};await Promise.all([M,W,V]);const J=new Set;await s.loadDependentModules(J,c,null,S,E);const m=new T;m.immutable=!1,m.setField("scale",0);const Y=s.compileScript(c,j),q=o=>("$view"in o&&o.$view&&(m.setField("scale",typeof o.$view=="object"?o.$view.scale:void 0),o.$view=m),p&&(o.$config=p),Y({vars:o,spatialReference:h}));return new R(t,s,c,q,new _,n,h)}repurposeFeature(t){return t.geometry&&!t.geometry.spatialReference&&(t.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(t.geometry,t.attributes,{fields:this.fields}),this._arcadeFeature}referencesGeometry(){return this._referencesGeometry}referencesScale(){return this._referencesScale}};const te=/^([0-9])/,re=/[^a-z0-9_\u0080-\uffff]/gi,ne=/_{2,}/g,ie=/^_/,ae=/_$/;function Re(e){return e==null?null:e.trim().replace(re,"_").replace(ne,"_").replace(ie,"").replace(ae,"").replace(te,"F$1")||null}const se=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],le=["field","normalizationField"];function Ge(e,t){if(e!=null&&t!=null){for(const r of Array.isArray(e)?e:[e])if(D(se,r,t),"visualVariables"in r&&r.visualVariables)for(const n of r.visualVariables)D(le,n,t)}}function D(e,t,r){if(e)for(const n of e){const i=H(n,t),a=i&&typeof i!="function"&&r.get(i);a&&K(n,a.name,t)}}function Pe(e,t){var r;if(e!=null&&((r=t==null?void 0:t.fields)!=null&&r.length))if("startField"in e){const n=t.get(e.startField),i=t.get(e.endField);e.startField=(n==null?void 0:n.name)??null,e.endField=(i==null?void 0:i.name)??null}else{const n=t.get(e.startTimeField),i=t.get(e.endTimeField);e.startTimeField=(n==null?void 0:n.name)??null,e.endTimeField=(i==null?void 0:i.name)??null}}const v=new Set;function oe(e,t){return e&&t?(v.clear(),y(v,e,t),Array.from(v).sort()):[]}function y(e,t,r){var n;if(r)if((n=t==null?void 0:t.fields)!=null&&n.length)if(r.includes("*"))for(const{name:i}of t.fields)e.add(i);else for(const i of r)I(e,t,i);else{if(r.includes("*"))return e.clear(),void e.add("*");for(const i of r)i!=null&&e.add(i)}}function I(e,t,r){if(typeof r=="string")if(t){const n=t.get(r);n&&e.add(n.name)}else e.add(r)}function ze(e,t){return N(t)||N(e)?[]:t.includes("*")?(e.fields??[]).map(r=>r.name):t}async function d(e,t,r){var a;if(!r)return;const{arcadeUtils:n}=await U(),i=n.extractFieldNames(r,(a=t==null?void 0:t.fields)==null?void 0:a.map(l=>l.name));for(const l of i)I(e,t,l)}async function G(e,t,r){if(r&&r!=="1=1"){const n=(await L(()=>import("./WhereClause-daac4082.js").then(i=>i.W),["assets/WhereClause-daac4082.js","assets/string-bf9c68ed.js","assets/typedArrayUtil-c81d173a.js","assets/executionError-fb3f283a.js","assets/datetime-b6333958.js"])).WhereClause.create(r,t);if(!n.isStandardized)throw new O("fieldUtils:collectFilterFields","Where clause is not standardized",{where:r});y(e,t,n.fieldNames)}}function Ce({displayField:e,fields:t}){return e||(t&&t.length?x(t,"name-or-title")||x(t,"unique-identifier")||x(t,"type-or-category")||ce(t):null)}function ce(e){for(const t of e){if(!t||!t.name)continue;const r=t.name.toLowerCase();if(r.includes("name")||r.includes("title"))return t.name}return null}function x(e,t){for(const r of e)if(r&&r.valueType&&r.valueType===t)return r.name;return null}async function ke(e,t){var n;if(!t)return;const r=(n=t.elevationInfo)==null?void 0:n.featureExpressionInfo;return r?r.collectRequiredFields(e,t.fieldsIndex):void 0}function ue(e,t,r){r.onStatisticExpression?d(e,t,r.onStatisticExpression.expression):e.add(r.onStatisticField)}async function Me(e,t,r){if(!t||!r||!("fields"in r))return;const n=[],i=r.popupTemplate;n.push(fe(e,t,i)),r.fields&&n.push(...r.fields.map(async a=>ue(e,t.fieldsIndex,a))),await Promise.all(n)}async function fe(e,t,r){const n=[];r!=null&&r.expressionInfos&&n.push(...r.expressionInfos.map(a=>d(e,t.fieldsIndex,a.expression)));const i=r==null?void 0:r.content;if(Array.isArray(i))for(const a of i)a.type==="expression"&&a.expressionInfo&&n.push(d(e,t.fieldsIndex,a.expressionInfo.expression));await Promise.all(n)}async function We(e,t,r){t&&(t.timeInfo&&u(r)&&r.timeExtent&&y(e,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),t.floorInfo&&y(e,t.fieldsIndex,[t.floorInfo.floorField]),u(r)&&u(r.where)&&await G(e,t.fieldsIndex,r.where))}async function je(e,t,r){t&&r&&await Promise.all(r.map(n=>de(e,t,n)))}async function de(e,t,r){t&&r&&(r.valueExpression?await d(e,t.fieldsIndex,r.valueExpression):r.field&&I(e,t.fieldsIndex,r.field))}function Je(e){if(!e)return[];const t="editFieldsInfo"in e&&e.editFieldsInfo;return t?oe(e.fieldsIndex,[t&&t.creatorField,t&&t.creationDateField,t&&t.editorField,t&&t.editDateField]):[]}async function Ye(e,t){const{labelingInfo:r,fieldsIndex:n}=t;r&&r.length&&await Promise.all(r.map(i=>pe(e,n,i)))}async function pe(e,t,r){if(!r)return;const n=r.getLabelExpression(),i=r.where;if(n.type==="arcade")await d(e,t,n.expression);else{const a=n.expression.match(/{[^}]*}/g);a&&a.forEach(l=>{I(e,t,l.slice(1,-1))})}await G(e,t,i)}function qe(e){const t=e.defaultValue;return t!==void 0&&C(e,t)?t:e.nullable?null:void 0}function P(e){return typeof e=="number"&&!isNaN(e)&&isFinite(e)}function me(e){return e===null||P(e)}const $="isInteger"in Number?Number.isInteger:e=>typeof e=="number"&&isFinite(e)&&Math.floor(e)===e;function ye(e){return e===null||$(e)}function z(e){return e!=null&&typeof e=="string"}function ge(e){return e===null||z(e)}function Fe(){return!0}function C(e,t){let r;switch(e.type){case"date":case"integer":case"long":case"small-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":r=e.nullable?ye:$;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":r=e.nullable?me:P;break;case"string":case"esriFieldTypeString":r=e.nullable?ge:z;break;default:r=Fe}return arguments.length===1?r:r(t)}const Ie=["integer","small-integer","single","double"],_e=new Set([...Ie,"esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]);function he(e){return e!=null&&_e.has(e.type)}function Xe(e){return e!=null&&(e.type==="string"||e.type==="esriFieldTypeString")}var g,F;function Be(e){return e==null||typeof e=="number"&&isNaN(e)?null:e}function He(e,t){return e==null||e.nullable&&t===null?null:he(e)&&!be(e.type,Number(t))?g.OUT_OF_RANGE:C(e,t)?e.domain?Z(e.domain,t):null:F.INVALID_TYPE}function be(e,t){const r=typeof e=="string"?k(e):e;if(!r)return!1;const n=r.min,i=r.max;return r.isInteger?$(t)&&t>=n&&t<=i:t>=n&&t<=i}function k(e){switch(e){case"esriFieldTypeSmallInteger":case"small-integer":return ve;case"esriFieldTypeInteger":case"integer":return xe;case"esriFieldTypeSingle":case"single":return we;case"esriFieldTypeDouble":case"double":return $e}}(function(e){e.OUT_OF_RANGE="numeric-range-validation-error::out-of-range"})(g||(g={})),function(e){e.INVALID_TYPE="type-validation-error::invalid-type"}(F||(F={}));const ve={min:-32768,max:32767,isInteger:!0},xe={min:-2147483648,max:2147483647,isInteger:!0},we={min:-34e37,max:12e37,isInteger:!1},$e={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};function Ke(e,t,r){switch(e){case f.INVALID_CODED_VALUE:return`Value ${r} is not in the coded domain - field: ${t.name}, domain: ${JSON.stringify(t.domain)}`;case f.VALUE_OUT_OF_RANGE:return`Value ${r} is out of the range of valid values - field: ${t.name}, domain: ${JSON.stringify(t.domain)}`;case F.INVALID_TYPE:return`Value ${r} is not a valid value for the field type - field: ${t.name}, type: ${t.type}, nullable: ${t.nullable}`;case g.OUT_OF_RANGE:{const{min:n,max:i}=k(t.type);return`Value ${r} is out of range for the number type - field: ${t.name}, type: ${t.type}, value range is ${n} to ${i}`}}}function Qe(e,t){return!Te(e,t,null)}function Te(e,t,r){if(!t||!t.attributes||!e){if(u(r))for(const a of e??[])r.add(a);return!0}const n=t.attributes;let i=!1;for(const a of e)if(!(a in n)){if(i=!0,!u(r))break;r.add(a)}return i}function Ze(e){return!!e&&["raster.itempixelvalue","raster.servicepixelvalue"].some(t=>e.toLowerCase().startsWith(t))}export{Je as C,ke as D,Ce as E,Ge as F,Ke as I,qe as M,Me as O,d as S,oe as T,Ye as W,he as a,y as b,Pe as c,Re as d,Be as e,He as f,Ze as h,U as i,We as j,Le as n,Oe as o,Ue as p,Xe as t,w as u,ze as v,I as w,Qe as x,je as z};
